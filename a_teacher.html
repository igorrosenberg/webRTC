<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Web RTC</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <style>
        video {
            display: none;
        }

        #vid-out {
            width: 100px;
            height: 100px;
            border: 1px solid yellow;
            position: fixed;
            top: 0px;
            right: 0px;
        }

        #vid-in {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>TEACHER</h1>
    <div class="row">
        <div class="col-sm-12" id="waitingRoom">
            <div id="messages"></div>
        </div>
    </div>
</div>

<video id="vid-out" controls></video>
<video id="vid-in" controls></video>

</body>

<script src="simplepeer.min.js"></script>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.27.4.min.js"></script>
<script src="pubNubWrapper.js"></script>
<script>
    // A. GUI interaction and comms
    const messagesTop = document.getElementById('messages')

    function error(error) {
        displayMessage('[ERROR] ' + error)
    }

    let displayMessage = function (message) {
        let pmessage = document.createElement('p')
        pmessage.appendChild(document.createTextNode(message))
        messagesTop.append(pmessage)
        if (message.length < 100)
            console.log(message)
        else
            console.log(message.substring(0, 99) + '...')
    }

</script>
<script>
    // B. WebRTC video chat

    // https://www.grafikart.fr/tutoriels/webrtc-864
    // https://github.com/feross/simple-peer

    function bindEvents(p, incomingData) {

        function streamToVideoElement(stream) {
            let $video = document.getElementById('vid-in');
            $video.srcObject = stream;
            $video.onloadedmetadata = function (e) {
                // hide waitingRoom ... somehow when OK
                document.getElementById('waitingRoom').style.display = 'none'

                // show peer video
                $video.style.display = 'block'
                $video.play();
            }
        }

        function linkConfig(data) {
            const dataJson = JSON.stringify(data)
            displayMessage("Sending to peer my details")
            // JSON sent to the other party
            myComms.send(dataJson)
        }

        p.on('error', error)
        p.on('stream', streamToVideoElement)    // A stream is grabbed
        p.on('signal', linkConfig)  // My own data is known

        // convert the incoming peer data to create a peer stream
        if (incomingData != undefined) {
            let parsedIncomingData = JSON.parse(incomingData)
            p.signal(parsedIncomingData)
        }
    }

    let p = null

    function start(isInitiator, incomingData) {

        function couldStartVideo(mediaStream) {

            p = new SimplePeer({
                initiator: isInitiator,
                stream: mediaStream,
                trickle: false,
                // config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }] }
            })
            bindEvents(p, incomingData)

            let $video = document.getElementById('vid-out');
            $video.srcObject = mediaStream;
            $video.onloadedmetadata = function (e) {
                // show self video
                $video.style.display = 'block'
                $video.play();
            }
        }

        function failStartVideo(err) {
            error(err.name + ": " + err.message);
        }

        let constraints = {audio: false, video: true};
        navigator.mediaDevices.getUserMedia(constraints).then(couldStartVideo).catch(failStartVideo)

        displayMessage("Started self-video on out", isInitiator)

    }

</script>
<script>
    // C. bring it all together : workflow

    let studentCount = 0

    function includeStudent(studentData) {
        let friendDataX = JSON.parse(studentData)
        displayMessage('includeStudent, renegotiate=' + friendDataX.renegotiate);
        if (friendDataX.renegotiate != true && studentCount++ == 0) {
            displayMessage('signaled!');
            p.signal(friendDataX)
        }
    }

    const teacherIn = 'TEACHER IN'
    const studentIn = 'STUDENT IN'

    function onMessageCallback(a, b) {
        displayMessage('[MESSAGE received] ' + a + ': ' + b)
        if (a == 'student') {
            if (b == studentIn) {
                // startTeacherClass
                start(true)
            } else {
                includeStudent(b)
            }
        }
    }

    const myComms = PubNubWrapper('1', 'teacher', onMessageCallback, error)

    myComms.send(teacherIn)

</script>

</html>
